"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.storeAccessToken = exports.getAccessTokenAsCookie = exports.getAccessToken = exports.initializeCookies = exports.COOKIE_KEY = void 0;
const universal_cookie_1 = __importDefault(require("universal-cookie"));
const utils_1 = require("../utils");
const WP_URL = utils_1.trimTrailingSlash(process.env.NEXT_PUBLIC_WORDPRESS_URL || process.env.WORDPRESS_URL);
exports.COOKIE_KEY = `${WP_URL}-at`;
function initializeCookies({ request, cookies, } = {}) {
    if (!(request || cookies)) {
        return new universal_cookie_1.default();
    }
    if (!cookies) {
        return new universal_cookie_1.default(request === null || request === void 0 ? void 0 : request.headers.cookie);
    }
    return new universal_cookie_1.default(cookies);
}
exports.initializeCookies = initializeCookies;
function getAccessToken(options) {
    const cookies = initializeCookies(options);
    const token = cookies.get(exports.COOKIE_KEY);
    if (!token) {
        return;
    }
    return utils_1.base64Decode(token);
}
exports.getAccessToken = getAccessToken;
function getAccessTokenAsCookie(options) {
    const cookies = initializeCookies(options);
    const token = cookies.get(exports.COOKIE_KEY);
    if (!token) {
        return;
    }
    return `${exports.COOKIE_KEY}=${token};`;
}
exports.getAccessTokenAsCookie = getAccessTokenAsCookie;
function storeAccessToken(token, res, options) {
    const cookies = initializeCookies(options);
    if (!token) {
        cookies.remove(exports.COOKIE_KEY);
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        res.setHeader('Set-Cookie', `${exports.COOKIE_KEY}=; expires=${yesterday.toUTCString()}; path=/`);
        return;
    }
    const encodedToken = utils_1.base64Encode(token);
    cookies.set(exports.COOKIE_KEY, encodedToken);
    res.setHeader('Set-Cookie', `${exports.COOKIE_KEY}=${encodedToken}; Max-Age=2592000; path=/`);
}
exports.storeAccessToken = storeAccessToken;
