"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.fetchData = void 0;
const api_1 = require("../api");
const utils_1 = require("./utils");
async function fetchData(context, options = {}) {
    var _a;
    const client = api_1.getApolloClient(context);
    const currentUrlPath = utils_1.getCurrentUrlPath(context);
    const uriPath = currentUrlPath;
    const pageInfo = await api_1.getUriInfo(client, uriPath);
    const isLatestPostsFrontPage = pageInfo && (pageInfo === null || pageInfo === void 0 ? void 0 : pageInfo.isFrontPage) && (pageInfo === null || pageInfo === void 0 ? void 0 : pageInfo.isPostsPage);
    await api_1.getGeneralSettings(client);
    if (!pageInfo) {
        throw new Error('Cannot retrieve page information');
    }
    if (pageInfo.isPostsPage) {
        await api_1.getPosts(client, options.posts);
    }
    if (pageInfo && (pageInfo === null || pageInfo === void 0 ? void 0 : pageInfo.isSingular) && !isLatestPostsFrontPage) {
        const variables = {
            id: uriPath,
            idType: 'URI',
        };
        const opts = options;
        if (opts.post && opts.post.variables) {
            opts.post.variables = Object.assign(Object.assign({}, variables), opts.post.variables);
        }
        await api_1.getContentNode(client, {
            fragments: (_a = opts.post) === null || _a === void 0 ? void 0 : _a.fragments,
            variables,
        });
    }
}
exports.fetchData = fetchData;
